import { BotKeyboard, TelegramClient } from '@mtcute/node';
import { API_HASH, API_ID, TELEGRAM_BOT_PANEL_TOKEN } from 'env.js';
import {
    CallbackDataBuilder,
    Dispatcher,
    filters,
    MemoryStateStorage,
    PropagationAction,
} from '@mtcute/dispatcher';
import { storage } from 'index.js';
import { GiveReferralsWizard } from 'telegram-panel/give-referrals-scene.js';
import { BuyAccountsWizard } from 'telegram-panel/buy-accounts-scene.js';

const tg = new TelegramClient({
    apiId: API_ID,
    apiHash: API_HASH,
});

const dp = Dispatcher.for<{}>(tg, {
    storage: new MemoryStateStorage(),
});

export const MainMenu = new CallbackDataBuilder('main', 'action');
export const defaultMenu = BotKeyboard.inline([
    [
        BotKeyboard.callback(
            'Ð—Ð°ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ñ‹',
            MainMenu.build({ action: 'buy_hams' })
        ),
        BotKeyboard.callback(
            'ÐÐ°ÐºÑ€ÑƒÑ‚Ð¸Ñ‚ÑŒ Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ð¾Ð²',
            MainMenu.build({ action: 'give_referrals' })
        ),
    ],
]);

dp.addScene(GiveReferralsWizard);
dp.addScene(BuyAccountsWizard);

dp.onNewMessage(filters.command('start'), async (msg) => {
    await msg.answerText(
        `ðŸ§¾ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ð¾Ð²: ${storage.data.referralAccounts.length}`,
        {
            replyMarkup: BotKeyboard.inline([
                [
                    BotKeyboard.callback(
                        'Ð—Ð°ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ñ‹',
                        MainMenu.build({ action: 'buy_hams' })
                    ),
                    BotKeyboard.callback(
                        'ÐÐ°ÐºÑ€ÑƒÑ‚Ð¸Ñ‚ÑŒ Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ð¾Ð²',
                        MainMenu.build({ action: 'give_referrals' })
                    ),
                ],
            ]),
        }
    );
});

dp.onCallbackQuery(
    MainMenu.filter({ action: 'give_referrals' }),
    async (msg, state) => {
        await state.enter(GiveReferralsWizard);
        await msg.answer({});
        await msg.client.sendText(msg.user, 'âœï¸ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ€ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑÑ‹Ð»ÐºÑƒ');

        return PropagationAction.ToScene;
    }
);

dp.onCallbackQuery(
    MainMenu.filter({ action: 'buy_hams' }),
    async (msg, state) => {
        await state.enter(BuyAccountsWizard);
        await msg.answer({});
        await msg.client.sendText(
            msg.user,
            'âœï¸ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð·Ð°ÐºÑƒÐ¿ÐºÐ¸'
        );

        return PropagationAction.ToScene;
    }
);

export function startTelegramPanel() {
    if (!TELEGRAM_BOT_PANEL_TOKEN) return;
    tg.run(
        {
            botToken: TELEGRAM_BOT_PANEL_TOKEN,
        },
        async (self) => {
            console.log(`Logged in as ${self.displayName}`);
        }
    );
}
